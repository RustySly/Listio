<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sign in – Listio</title>
<style>
  body{margin:0;display:grid;place-items:center;min-height:100vh;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  form{display:grid;gap:10px;width:320px;padding:24px;border:1px solid #e5e7eb;border-radius:10px}
  input{padding:10px;border:1px solid #e5e7eb;border-radius:6px}
  button{padding:10px;border:none;border-radius:6px;background:#2d6cdf;color:#fff;cursor:pointer}
  .muted{color:#6b7280;font-size:12px}
  .link{background:#eef2ff;color:#1e40af;text-align:center}
  .msg{color:#c2410c;font-size:12px;min-height:16px}
  #status{margin-top:12px;font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;border-radius:6px;padding:8px;display:none}
</style>
</head>
<body>
  <form id="auth">
    <h3 style="margin:0 0 4px">Sign in</h3>
    <div class="muted">Use email + password. We’ll create an account if needed.</div>
    <input id="email" type="email" placeholder="you@example.com" required />
    <input id="password" type="password" placeholder="Password" required />
    <button type="submit">Continue</button>
    <button id="signup" type="button" class="link">Create account</button>
    <div id="msg" class="msg"></div>
    <div id="status"></div>
  </form>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Your project (given)
    const SUPABASE_URL = "https://xqxuccpotbdmqqhxisdf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxeHVjY3BvdGJkbXFxaHhpc2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTg5MjYsImV4cCI6MjA3MDMzNDkyNn0.Jb3LaflzKGT6di_t14FLbGdexQ2lTKQ-dIt5Ve9aP-8";
    const STORAGE_KEY = "listio-auth-v1";
    const APP_URL = "/Listio/"; // index.html lives here

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey: STORAGE_KEY }
    });

    const form = document.getElementById('auth');
    const msg  = document.getElementById('msg');
    const status = document.getElementById('status');

    function setStatus(text){
      status.textContent = text;
      status.style.display = 'block';
    }
    function clearStatus(){ status.style.display = 'none'; }

    // If already signed in, skip to app
    (async () => {
      const { data } = await supabase.auth.getSession();
      if (data?.session) {
        setStatus("SESSION OK: " + data.session.user.email + " → going to app…");
        setTimeout(()=>location.replace(APP_URL), 300);
      }
    })();

    // Handle the hash after email confirmation
    supabase.auth.onAuthStateChange(async (event, s) => {
      if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
        if (location.hash.includes('access_token')) {
          history.replaceState(null, '', location.pathname);
        }
        setStatus("SIGNED IN as " + (s?.user?.email || "(unknown)") + " → going to app…");
        setTimeout(()=>location.replace(APP_URL), 300);
      }
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearStatus(); msg.textContent = "…signing in";
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { msg.textContent = error.message; } else { msg.textContent = ""; }
    });

    document.getElementById('signup').addEventListener('click', async ()=>{
      clearStatus(); msg.textContent = "…creating account";
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signUp({ email, password });
      msg.textContent = error ? error.message : "Check your email to confirm, then come back here.";
    });
  </script>
</body>
</html>
