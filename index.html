<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Boards â€“ Minimal Columns</title>
<style>
  :root {
    --bg:#f7f8fa; --panel:#ffffff; --ink:#1f2937; --muted:#9aa3ae; --accent:#2d6cdf;
    --line:#eceff3; --pill-bg:#eef3ff; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4343;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
  .app{display:grid;grid-template-columns:240px 1fr;height:100%}
  .sidebar{padding:18px;border-right:1px solid var(--line);background:var(--bg)}
  .brand{font-weight:700;font-size:22px;letter-spacing:-0.02em}
  .board{height:calc(100% - 0px);overflow:auto;padding:16px;display:flex;gap:16px;background:#fafafa}
  .column{background:var(--panel);border:1px solid var(--line);border-radius:8px;min-width:280px;max-width:320px;display:flex;flex-direction:column;box-shadow:0 10px 24px rgba(17,24,39,.06)}
  .col-header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--line)}
  .col-title{font-weight:600;font-size:14px;padding:4px;border-radius:4px}
  .col-title[contenteditable="true"]:focus{outline:1px solid var(--accent);background:var(--pill-bg)}
  .col-actions{margin-left:auto;display:flex;gap:4px}
  .icon-btn{all:unset;width:24px;height:24px;border-radius:4px;display:grid;place-items:center;cursor:pointer;border:1px solid var(--line);font-size:12px;color:var(--muted)}
  .icon-btn:hover{background:#f5f5f5}
  .cards{display:flex;flex-direction:column;gap:8px;padding:10px;min-height:50px}
  .card{background:#fff;border:1px solid var(--line);border-radius:6px;padding:8px;display:grid;grid-template-columns:auto 1fr auto;align-items:flex-start;gap:8px}
  .checkbox{width:16px;height:16px;accent-color:var(--accent)}
  .card-text{white-space:pre-wrap;outline:none;font-size:13px}
  .pill-date{font-size:11px;color:#d11f3e;background:#ffecee;padding:2px 6px;border-radius:999px}
  .adder{border-top:1px dashed var(--line);padding:8px;display:flex;gap:6px}
  .adder input{flex:1;border:1px solid var(--line);border-radius:4px;padding:8px;background:transparent;color:var(--ink);font-size:13px}
  .btn{all:unset;background:#eef2ff;border:1px solid #d6e6ff;padding:6px 10px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-size:13px}
  .btn:hover{background:#e7edff}
  /* auth overlay */
  #auth{position:fixed;inset:0;display:grid;place-items:center;background:#fff}
  #auth form{display:grid;gap:10px;width:320px;padding:24px;border:1px solid var(--line);border-radius:10px;background:#fff;box-shadow:0 10px 24px rgba(17,24,39,.06)}
  #auth h2{margin:0 0 4px 0}
  #auth .hint{color:var(--muted);font-size:12px;margin-bottom:4px}
  #auth input{padding:10px;border:1px solid var(--line);border-radius:6px;font-size:14px}
  #auth button{padding:10px;border-radius:6px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  #auth .link{background:#eef2ff;color:#1e40af;text-align:center}
  #auth .msg{color:#d11f3e;font-size:12px;height:14px}
  .top{display:flex;align-items:center;gap:8px;padding:12px 18px;border-bottom:1px solid var(--line);background:#fff}
  .spacer{flex:1}
</style>
</head>
<body>
  <div class="top">
    <div class="brand">Columns</div>
    <div class="spacer"></div>
    <button id="signout" class="btn" style="display:none">Sign out</button>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div style="font-weight:600;margin-bottom:8px">Your Board</div>
      <div class="hint" style="color:var(--muted);font-size:12px">Columns appear on the right</div>
    </aside>
    <main class="board"></main>
  </div>

  <!-- Auth overlay -->
  <div id="auth">
    <form id="auth-form">
      <h2>Sign in</h2>
      <div class="hint">Use email + password. We'll create your account if it doesn't exist.</div>
      <input id="email" type="email" placeholder="you@example.com" required />
      <input id="password" type="password" placeholder="Password" required />
      <button id="signin" type="submit">Continue</button>
      <button id="signup" type="button" class="link">Create account</button>
      <div class="msg" id="auth-msg"></div>
    </form>
  </div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // === CONFIG: replace these two ===
    const SUPABASE_URL = "https://xqxuccpotbdmqqhxisdf.supabase.co";           // e.g., https://abcdxyz.supabase.co
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxeHVjY3BvdGJkbXFxaHhpc2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTg5MjYsImV4cCI6MjA3MDMzNDkyNn0.Jb3LaflzKGT6di_t14FLbGdexQ2lTKQ-dIt5Ve9aP-8";      // anon public key

    // Guard: fail early if placeholders are still here
    (function guard(){
      const looksPlaceholder = (s) =>
        !s || /YOUR_SUPABASE_URL|YOUR_SUPABASE_ANON_KEY|^https?:\/\/.+\.supabase\.co$/.test(s) === false
          ? false : false; // not reliable; show explicit helper below
      if (!SUPABASE_URL || SUPABASE_URL.includes("YOUR_SUPABASE_URL") ||
          !SUPABASE_KEY || SUPABASE_KEY.includes("YOUR_SUPABASE_ANON_KEY")) {
        document.getElementById('auth-msg').textContent =
          "Missing Supabase URL/key. Add your project URL and anon key (Settings â†’ API).";
      }
    })();

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let session = null;
    let currentBoardId = null;

    // ===== Auth UI =====
    const authEl = document.getElementById('auth');
    const authMsg = document.getElementById('auth-msg');
    const signoutBtn = document.getElementById('signout');

    document.getElementById('auth-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      authMsg.textContent = "";
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) authMsg.textContent = error.message;
    });

    document.getElementById('signup').addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      authMsg.textContent = "";
      const { data, error } = await supabase.auth.signUp({ email, password });
      authMsg.textContent = error ? error.message : "Check your email to confirm your account.";
    });

    signoutBtn.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
    });

    supabase.auth.onAuthStateChange(async (_evt, s) => {
      session = s?.session || null;
      authEl.style.display = session ? 'none' : 'grid';
      signoutBtn.style.display = session ? 'inline-flex' : 'none';
      if (session) { await boot(); }
    });

    // ===== Data layer =====
    async function boot(){
      // Ensure one board
      let { data: boards, error: bErr } = await supabase
        .from('boards').select('*').eq('owner_id', session.user.id).limit(1);
      if (bErr) { console.error(bErr); return; }
      if (!boards || boards.length === 0) {
        const { data: created, error: cErr } = await supabase
          .from('boards').insert({ title: 'My Board', owner_id: session.user.id })
          .select('*').single();
        if (cErr) { console.error(cErr); return; }
        currentBoardId = created.id;
      } else {
        currentBoardId = boards[0].id;
      }
      await loadColumns();
      subscribeRealtime();
    }

    async function loadColumns(){
      const { data: columns, error } = await supabase
        .from('columns')
        .select('id, title, position')
        .eq('board_id', currentBoardId)
        .order('position', { ascending: true });
      if (error) { console.error(error); return; }

      const boardEl = document.querySelector('.board');
      boardEl.innerHTML = '';

      for (const col of columns) {
        const colEl = renderColumn(col);
        boardEl.appendChild(colEl);
        const { data: cards } = await supabase
          .from('cards').select('*').eq('column_id', col.id).order('position', { ascending: true });
        const cardsEl = colEl.querySelector('.cards');
        (cards || []).forEach(card => cardsEl.appendChild(renderCard(card)));
      }

      const add = document.createElement('button');
      add.className = 'btn';
      add.textContent = '+ Add Column';
      add.onclick = async ()=>{
        await supabase.from('columns').insert({
          board_id: currentBoardId, title: 'New Column', owner_id: session.user.id, position: Date.now()
        });
      };
      boardEl.appendChild(add);
    }

    function renderColumn(col){
      const wrap = document.createElement('div');
      wrap.className = 'column';
      wrap.innerHTML = `
        <div class="col-header">
          <div class="col-title" contenteditable="true">${col.title}</div>
          <div class="col-actions">
            <button class="icon-btn" title="Share">ðŸ”—</button>
            <button class="icon-btn" title="Delete">ðŸ—‘</button>
          </div>
        </div>
        <div class="cards"></div>
        <div class="adder">
          <input placeholder="Add a card..." />
          <button class="btn">Add</button>
        </div>
      `;

      // title edit
      const titleEl = wrap.querySelector('.col-title');
      titleEl.addEventListener('blur', async ()=>{
        const newTitle = titleEl.textContent.trim() || 'Untitled';
        await supabase.from('columns').update({ title: newTitle }).eq('id', col.id);
      });

      // delete
      wrap.querySelectorAll('.icon-btn')[1].onclick = async ()=>{
        await supabase.from('columns').delete().eq('id', col.id);
      };

      // share
      wrap.querySelectorAll('.icon-btn')[0].onclick = ()=> openShareDialog(col.id);

      // add card
      const input = wrap.querySelector('.adder input');
      const btn = wrap.querySelector('.adder button');
      btn.onclick = async ()=>{
        const text = input.value.trim();
        if (!text) return;
        await supabase.from('cards').insert({
          column_id: col.id, text, position: Date.now(), created_by: session.user.id
        });
        input.value = '';
      };

      return wrap;
    }

    function renderCard(card){
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <input class="checkbox" type="checkbox" ${card.checked ? 'checked' : ''}/>
        <div class="card-text" contenteditable="true">${card.text || ''}</div>
        <div class="meta"><span class="pill-date">${card.due_date || ''}</span></div>
      `;
      el.querySelector('.checkbox').addEventListener('change', async (e)=>{
        await supabase.from('cards').update({ checked: e.target.checked }).eq('id', card.id);
      });
      el.querySelector('.card-text').addEventListener('blur', async (e)=>{
        await supabase.from('cards').update({ text: e.target.textContent }).eq('id', card.id);
      });
      return el;
    }

    function subscribeRealtime(){
      supabase.channel('columns-ch')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'columns' }, () => loadColumns())
        .subscribe();
      supabase.channel('cards-ch')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'cards' }, () => loadColumns())
        .subscribe();
    }

    // Basic share dialog (manual user_id for now)
    function openShareDialog(columnId){
      const email = prompt('Enter collaborator email (ask them to sign up first)');
      if (!email) return;
      const role = prompt("Role? Type 'viewer' or 'editor'", 'viewer');
      if (!role || !['viewer','editor'].includes(role)) return alert('Invalid role');
      alert('For now, paste their user_id (we will automate later via Edge Function).');
      const userId = prompt('Paste collaborator user_id');
      if (!userId) return;
      supabase.from('column_access').insert({ column_id: columnId, user_id: userId, role })
        .then(({ error }) => alert(error ? error.message : 'Shared!'));
    }

    // Kick off: fetch current session so the overlay hides if already logged in
    (async () => {
      const { data } = await supabase.auth.getSession();
      session = data?.session || null;
      authEl.style.display = session ? 'none' : 'grid';
      signoutBtn.style.display = session ? 'inline-flex' : 'none';
      if (session) await boot();
    })();
  </script>
</body>
</html>
