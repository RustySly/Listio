<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Listio â€“ Board</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #333; color: #fff; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    header button { background: #555; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    #board { display: flex; padding: 10px; gap: 10px; }
    .column { background: white; border-radius: 4px; padding: 10px; min-width: 200px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .column h2 { font-size: 1.1em; margin-top: 0; }
    .card { background: #eee; padding: 5px; margin: 5px 0; border-radius: 3px; }
    button.btn { margin-top: 5px; background: #007bff; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer; }
    button.btn:hover { background: #0056b3; }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="common.js"></script>
</head>
<body>

<header>
  <h1>My Board</h1>
  <button id="sign-out">Sign Out</button>
</header>

<main>
  <div id="board"></div>
  <button id="create-board" class="btn">Create Board</button>
  <button id="add-column" class="btn">Add Column</button>
</main>

<script>
let session = null;
let currentBoardId = null;
const boardEl = document.getElementById('board');

document.addEventListener('DOMContentLoaded', async () => {
  session = await requireAuth();
  if (!session) return; // redirected if not logged in
  await ensureBoard();
  await loadBoard();
});

document.getElementById('sign-out').addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.href = 'auth.html';
});

document.getElementById('create-board').addEventListener('click', async () => {
  const { data, error } = await supabase
    .from('boards')
    .insert({ owner_id: session.user.id, name: 'New Board' })
    .select()
    .single();
  if (error) {
    alert('Create board error: ' + error.message);
    return;
  }
  currentBoardId = data.id;
  await loadBoard();
});

document.getElementById('add-column').addEventListener('click', async () => {
  if (!currentBoardId) {
    alert('Create or select a board first');
    return;
  }
  const { error } = await supabase.from('columns').insert({
    board_id: currentBoardId,
    title: 'New Column',
    owner_id: session.user.id,
    position: Math.floor(Date.now()/1000)
  });
  if (error) alert('Insert column failed: ' + error.message);
});

// Ensure user has a board
async function ensureBoard() {
  const { data, error } = await supabase
    .from('boards')
    .select()
    .eq('owner_id', session.user.id)
    .limit(1)
    .single();
  if (error && error.code !== 'PGRST116') {
    console.error(error);
    return;
  }
  if (!data) {
    const { data: newBoard, error: createError } = await supabase
      .from('boards')
      .insert({ owner_id: session.user.id, name: 'My Board' })
      .select()
      .single();
    if (createError) {
      console.error(createError);
      return;
    }
    currentBoardId = newBoard.id;
  } else {
    currentBoardId = data.id;
  }
}

// Load board from DB
async function loadBoard() {
  if (!currentBoardId) return;

  const { data: columns, error } = await supabase
    .from('columns')
    .select('id, title, position')
    .eq('board_id', currentBoardId)
    .order('position', { ascending: true });

  if (error) {
    console.error(error);
    return;
  }

  boardEl.innerHTML = '';
  (columns || []).forEach(col => {
    const colDiv = document.createElement('div');
    colDiv.className = 'column';
    colDiv.innerHTML = `<h2>${col.title}</h2>`;
    boardEl.appendChild(colDiv);
  });
}

// Real-time updates for columns
supabase
  .channel('realtime:columns')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'columns' }, payload => {
    if (payload.new && payload.new.board_id === currentBoardId) {
      loadBoard();
    }
  })
  .subscribe();

</script>
</body>
</html>
