<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Columns ‚Äì Listio</title>
<style>
  :root{
    --bg:#ffffff; --panel:#ffffff; --ink:#111827; --muted:#9aa3ae; --accent:#2d6cdf;
    --line:#eceff3; --pill-bg:#eef3ff; --danger:#ef4343; --side:#f4f5f7;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:#fff;color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* App frame */
  .app{display:grid;grid-template-columns:250px 1fr;min-height:100vh}
  .sidebar{
    background:var(--side);border-right:1px solid var(--line);padding:16px 14px 80px;position:relative;
  }
  .brand-row{display:flex;align-items:center;justify-content:space-between;margin:4px 2px 14px}
  .brand{font-weight:800;letter-spacing:.2px;font-size:32px} /* bigger like screenshot */
  .dots{width:22px;height:22px;border-radius:8px;display:grid;place-items:center;color:#6b7280}
  .nav{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;color:#111827;text-decoration:none}
  .nav a .icon{width:22px;height:22px;border-radius:8px;display:grid;place-items:center;background:#eaf1ff;color:#2d6cdf;font-size:12px}
  .nav a.active{background:#dbe9ff}
  .nav a.muted{color:#9aa3ae}
  .nav a .ghost{background:transparent;border:1px dashed var(--line);color:#9aa3ae}

  /* floating docks (bottom corners) */
  .dock-left, .dock-right{
    position:fixed;bottom:16px;display:flex;gap:10px;background:#fff;border:1px solid var(--line);
    padding:8px;border-radius:14px;box-shadow:0 6px 18px rgba(17,24,39,.08);z-index:5
  }
  .dock-left{left:16px}
  .dock-right{right:16px}
  .circle{
    width:34px;height:34px;border-radius:50%;display:grid;place-items:center;border:1px solid var(--line);cursor:pointer
  }
  .circle.black{background:#111827;color:#fff;border-color:#111827}

  /* Board canvas */
  .board{
    height:100vh; overflow:auto; padding:28px 28px 100px; display:flex; gap:18px; align-items:stretch; background:#fff;
  }

  /* Column look */
  .column{
    background:transparent; border:0; border-radius:0; min-width:320px; max-width:360px;
    display:flex; flex-direction:column; height:100%;
  }
  .col-header{display:flex;align-items:center;gap:14px;padding:0 0 12px;border-bottom:1px solid var(--line)}
  .col-title{font-weight:900;font-size:44px;line-height:1.05;padding:4px 6px;border-radius:8px} /* matches shot sizing */
  .col-title[contenteditable="true"]:focus{outline:1.5px solid var(--accent);background:var(--pill-bg)}
  .col-actions{margin-left:auto;display:flex;gap:6px}
  .icon-btn{all:unset;width:28px;height:28px;border-radius:8px;display:grid;place-items:center;cursor:pointer;border:1px solid var(--line);font-size:12px;color:#6b7280}
  .icon-btn:hover{background:#f5f5f5}

  /* "+ Add card" ghost (hover becomes a rounded pill) */
  .add-card-ghost{
    display:inline-flex;align-items:center;gap:10px;
    color:#9aa3ae;font-size:18px;margin:8px 0 6px;padding:8px 12px;border-radius:14px;
    transition:background .15s ease,color .15s ease;
    cursor:pointer; user-select:none;
  }
  .add-card-ghost .plus{font-size:22px;color:#9aa3ae;transition:color .15s ease}
  .add-card-ghost .small-rect{
    margin-left:10px;width:26px;height:26px;border-radius:8px;border:1px solid #d7dbe1;display:grid;place-items:center;color:#c7cbd1;font-size:16px
  }
  .add-card-ghost:hover{background:#f3f4f6;color:#374151}
  .add-card-ghost:hover .plus{color:#2d6cdf}

  /* Composer card (when Add card is clicked) */
  .composer{
    background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px 16px 12px;
    box-shadow:0 12px 26px rgba(17,24,39,.10); width:520px; max-width:92%;
  }
  .composer .top{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .composer .chk{width:20px;height:20px;accent-color:var(--accent)}
  .composer .title{
    border:0;outline:none;font-size:24px;font-weight:600;color:#111827;width:100%;
  }
  .composer .notes{
    border:0;outline:none;font-size:18px;color:#9aa3ae;resize:vertical;width:100%;min-height:28px;margin-top:4px
  }
  .composer .bar{display:flex;align-items:center;gap:18px;padding-top:10px;color:#c3c7cf}
  .composer .bar .pill{
    width:36px;height:36px;border:1px solid #e3e7ee;border-radius:50%;display:grid;place-items:center;cursor:pointer
  }
  .composer .bar .ghost{opacity:.8}
  .composer .drop{margin-left:auto;color:#c3c7cf}

  .cards{display:flex;flex-direction:column;gap:8px;padding:14px 0;min-height:48px;flex:1}
  .card{
    background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;
    display:grid;grid-template-columns:auto 1fr auto;align-items:flex-start;gap:10px;box-shadow:0 8px 18px rgba(17,24,39,.06)
  }
  .checkbox{width:16px;height:16px;accent-color:var(--accent)}
  .card-text{white-space:pre-wrap;outline:none;font-size:14px}

  .adder{display:none} /* we no longer use the old adder UI */

  /* Right-side lonely plus to add column */
  .canvas-plus{
    position:relative;flex:1;border-left:1px solid var(--line);min-width:240px;
    display:block;cursor:pointer;
  }
  .canvas-plus::after{
    content:"+"; position:absolute; inset:0; display:grid; place-items:center;
    color:#e5e7eb; font-size:28px; pointer-events:none; transition:opacity .15s ease;
  }
  .canvas-plus::before{
    content:"Add Column"; position:absolute; left:50%; top:calc(50% + 26px);
    transform:translateX(-50%); color:#c7cad0; font-size:14px; opacity:0; transition:opacity .15s ease;
  }
  .canvas-plus:hover{background:#fafbfc}
  .canvas-plus:hover::before{opacity:1}

  /* drag */
  .dragging{opacity:.6}
  .cards.drag-over{outline:1px dashed var(--accent);outline-offset:-4px}

  /* debug toast */
  #dbg{position:fixed;left:12px;bottom:12px;max-width:600px;padding:8px 10px;background:#fff3cd;border:1px solid #ffe08a;border-radius:8px;font:12px system-ui;color:#533f03;z-index:9999;white-space:pre-wrap;display:none}
</style>
</head>
<body>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand-row">
        <div class="brand">Listio</div>
        <div class="dots">‚ãØ</div>
      </div>

      <nav class="nav">
        <a class="active" href="#">
          <span class="icon">‚ñ¶</span>
          <span>Listio</span>
        </a>
        <a class="muted" href="#" id="add-board-link">
          <span class="icon ghost">Ôºã</span>
          <span>Add board</span>
        </a>

        <a class="muted" href="#" style="margin-top:16px"><span>üóÇ</span><span>Archive</span></a>
        <a class="muted" href="#"><span>üóë</span><span>Trash</span></a>
      </nav>
    </aside>

    <!-- Board -->
    <main class="board" id="board">
      <!-- columns injected here -->
      <div class="canvas-plus" id="add-col-ghost" title="Add Column"></div>
    </main>
  </div>

  <!-- floating docks -->
  <div class="dock-left">
    <div class="circle">‚ñ¶</div>
    <div class="circle">üîç</div>
    <div class="circle">üîî</div>
    <div class="circle black">L</div>
  </div>
  <div class="dock-right">
    <div class="circle">‚Ü∫</div>
    <div class="circle">‚öôÔ∏è</div>
    <div class="circle">üóë</div>
  </div>

  <div id="dbg"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="./common.js"></script>
  <script>
  // ===== helpers
  const boardEl = document.getElementById('board');
  const dbg = document.getElementById('dbg');
  function show(msg){ dbg.textContent = msg; dbg.style.display = 'block'; }
  function hideDbg(){ dbg.style.display = 'none'; }

  let session = null, currentBoardId = null;

  // ===== gate
  (async ()=>{
    session = await requireAuth('./auth.html');
    if (!session) return;
    await ensureBoard();
    subscribeRealtime();
    await loadBoard();
  })();

  // ===== data
  async function ensureBoard(){
    const { data: boards, error } = await supabase
      .from('boards').select('*').eq('owner_id', session.user.id).limit(1);
    if (error){ show('Load boards error: '+error.message); return; }
    if (!boards?.length){
      const { data: created, error: cErr } = await supabase
        .from('boards').insert({ owner_id: session.user.id, name: 'My Board' }).select('*').single();
      if (cErr){ show('Create board error: '+cErr.message); return; }
      currentBoardId = created.id;
    } else { currentBoardId = boards[0].id; }
  }

  async function loadBoard(){
    hideDbg();

    const { data: columns, error } = await supabase
      .from('columns').select('id,title,position').eq('board_id', currentBoardId)
      .order('position', { ascending: true });
    if (error){ show('Load columns error: '+error.message); return; }

    const next = document.createElement('div');

    (columns||[]).forEach(c => next.appendChild(renderColumn(c)));

    // right-side lonely plus region (always last)
    const canvas = document.createElement('div');
    canvas.className = 'canvas-plus';
    canvas.id = 'add-col-ghost';
    canvas.title = 'Add Column';
    canvas.onclick = addColumn;
    next.appendChild(canvas);

    boardEl.replaceChildren(...next.children);
  }

  async function addColumn(){
    const { error } = await supabase.from('columns').insert({
      board_id: currentBoardId,
      title: 'New Column',
      owner_id: session.user.id,
      position: Math.floor(Date.now()/1000)
    });
    if (error) show('Insert column failed: '+error.message);
  }

  function renderColumn(col){
    const wrap = document.createElement('div');
    wrap.className = 'column';
    wrap.draggable = true;
    wrap.dataset.colId = col.id;

    wrap.innerHTML = `
      <div class="col-header">
        <div class="col-title" contenteditable="true">${col.title}</div>
        <div class="add-card-ghost" data-col="${col.id}">
          <span class="plus">Ôºã</span>
          <span>Add card</span>
          <span class="small-rect">Ôºã</span>
        </div>
        <div class="col-actions" title="Delete">
          <button class="icon-btn">üóë</button>
        </div>
      </div>
      <div class="cards" data-col="${col.id}"></div>
    `;

    // rename column
    const titleEl = wrap.querySelector('.col-title');
    titleEl.addEventListener('blur', async ()=>{
      const newTitle = titleEl.textContent.trim() || 'Untitled';
      const { error } = await supabase.from('columns').update({ title: newTitle }).eq('id', col.id);
      if (error) show('Rename column failed: '+error.message);
    });

    // delete column
    wrap.querySelector('.icon-btn').onclick = async ()=>{
      const { error } = await supabase.from('columns').delete().eq('id', col.id);
      if (error) show('Delete column failed: '+error.message);
    };

    // load cards
    (async ()=>{
      const { data: cards, error } = await supabase
        .from('cards').select('*').eq('column_id', col.id).order('position',{ascending:true});
      if (error){ show('Load cards error: '+error.message); return; }
      const cardsEl = wrap.querySelector('.cards');
      (cards||[]).forEach(card => cardsEl.appendChild(renderCard(card)));
      enableCardDnD(cardsEl);
    })();

    // add card ghost -> composer
    wrap.querySelector('.add-card-ghost').addEventListener('click', ()=>{
      openComposer(wrap.querySelector('.cards'), col.id);
    });

    enableColumnDnD(wrap);
    return wrap;
  }

  function renderCard(card){
    const el = document.createElement('div');
    el.className = 'card';
    el.draggable = true;
    el.dataset.cardId = card.id;
    el.innerHTML = `
      <input class="checkbox" type="checkbox" ${card.checked ? 'checked' : ''}/>
      <div class="card-text" contenteditable="true">${card.text || ''}</div>
      <div></div>
    `;
    el.querySelector('.checkbox').addEventListener('change', async (e)=>{
      const { error } = await supabase.from('cards').update({ checked: e.target.checked }).eq('id', card.id);
      if (error) show('Toggle card failed: '+error.message);
    });
    el.querySelector('.card-text').addEventListener('blur', async (e)=>{
      const { error } = await supabase.from('cards').update({ text: e.target.textContent }).eq('id', card.id);
      if (error) show('Edit card failed: '+error.message);
    });
    return el;
  }

  /* ===== Inline composer (3rd screenshot behavior) ===== */
  function openComposer(cardsEl, colId){
    // If a composer is already open in this column, do nothing
    if (cardsEl.querySelector('.composer')) return;

    const composer = document.createElement('div');
    composer.className = 'composer';
    composer.innerHTML = `
      <div class="top">
        <input class="chk" type="checkbox" />
        <input class="title" placeholder="New card" />
      </div>
      <textarea class="notes" placeholder="Notes"></textarea>
      <div class="bar">
        <div class="pill add-pill" title="Add">Ôºã</div>
        <div class="pill ghost" title="Assign">üë§</div>
        <div class="pill ghost" title="Date">üìÖ</div>
        <div class="pill ghost" title="Attach">üñá</div>
        <div class="drop">Drop files here</div>
      </div>
    `;

    // insert at top
    cardsEl.prepend(composer);
    const titleInput = composer.querySelector('.title');
    const notesInput = composer.querySelector('.notes');
    titleInput.focus();

    async function submit(){
      const title = titleInput.value.trim();
      const notes = notesInput.value.trim();
      if (!title) { close(); return; }

      const text = notes ? (title + "\n" + notes) : title;
      const { error } = await supabase.from('cards').insert({
        column_id: colId,
        text,
        position: Math.floor(Date.now()/1000),
        created_by: session.user.id
      });
      if (error) show('Add card failed: '+error.message);
      close();
    }
    function close(){
      composer.remove();
    }

    composer.querySelector('.add-pill').addEventListener('click', submit);
    composer.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); submit(); }
      if (e.key === 'Escape'){ e.preventDefault(); close(); }
    });
  }

  // ===== Drag & drop ‚Äì Columns
  function enableColumnDnD(colEl){
    colEl.addEventListener('dragstart', e=>{ colEl.classList.add('dragging'); e.dataTransfer.setData('text/col', colEl.dataset.colId); });
    colEl.addEventListener('dragend', ()=> colEl.classList.remove('dragging'));
    boardEl.addEventListener('dragover', e=>{
      const dragging = document.querySelector('.column.dragging');
      if(!dragging) return;
      e.preventDefault();
      const siblings = [...boardEl.querySelectorAll('.column')].filter(x=>x!==dragging);
      const after = siblings.find(s=> e.clientX <= s.getBoundingClientRect().left + s.offsetWidth/2 );
      boardEl.insertBefore(dragging, after || null);
    });
    boardEl.addEventListener('drop', async ()=>{
      const ids = [...boardEl.querySelectorAll('.column')].map(el=>el.dataset.colId).filter(Boolean);
      const updates = ids.map((id, i)=> ({ id, position: i+1 }));
      if(!ids.length) return;
      const { error } = await supabase.from('columns').upsert(updates);
      if (error) show('Reorder columns failed: '+error.message);
    });
  }

  // ===== Drag & drop ‚Äì Cards
  function enableCardDnD(cardsEl){
    cardsEl.addEventListener('dragover', e=>{
      const dragging = document.querySelector('.card.dragging');
      if(!dragging) return;
      e.preventDefault();
      cardsEl.classList.add('drag-over');
      const siblings = [...cardsEl.querySelectorAll('.card')].filter(x=>x!==dragging);
      const after = siblings.find(s=> e.clientY <= s.getBoundingClientRect().top + s.offsetHeight/2 );
      cardsEl.insertBefore(dragging, after || null);
    });
    cardsEl.addEventListener('dragleave', ()=> cardsEl.classList.remove('drag-over'));
    cardsEl.addEventListener('drop', async e=>{
      cardsEl.classList.remove('drag-over');
      const colId = cardsEl.dataset.col;
      const ids = [...cardsEl.querySelectorAll('.card')].map(el=>el.dataset.cardId);
      const updates = ids.map((id,i)=> ({ id, position: i+1, column_id: colId }));
      if(!ids.length) return;
      const { error } = await supabase.from('cards').upsert(updates);
      if (error) show('Reorder cards failed: '+error.message);
    });

    cardsEl.addEventListener('dragstart', e=>{
      const card = e.target.closest('.card'); if(!card) return;
      card.classList.add('dragging');
    });
    cardsEl.addEventListener('dragend', e=>{
      const card = e.target.closest('.card'); if(!card) return;
      card.classList.remove('dragging');
    });
  }

  // ===== Realtime
  function subscribeRealtime(){
    supabase.channel('columns-rt')
      .on('postgres_changes',{event:'*',schema:'public',table:'columns'}, loadBoard)
      .subscribe();
    supabase.channel('cards-rt')
      .on('postgres_changes',{event:'*',schema:'public',table:'cards'}, loadBoard)
      .subscribe();
  }

  // click on the initial canvas-plus that‚Äôs present in the static HTML (before first load)
  document.getElementById('add-col-ghost')?.addEventListener('click', addColumn);
  </script>
</body>
</html>
