<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Listio</title>
<style>
  :root{--line:#eceff3;--accent:#2d6cdf;--muted:#9aa3ae;--ink:#1f2937}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f7f8fa;color:var(--ink)}
  .top{display:flex;gap:8px;align-items:center;padding:12px 18px;border-bottom:1px solid var(--line);background:#fff}
  .spacer{flex:1}
  .btn{all:unset;background:#eef2ff;border:1px solid #d6e6ff;padding:6px 10px;border-radius:6px;cursor:pointer}
  .app{display:grid;grid-template-columns:240px 1fr;height:calc(100% - 49px)}
  .sidebar{padding:18px;border-right:1px solid var(--line);background:#fff}
  .board{height:100%;overflow:auto;padding:16px}
  #dbg{position:fixed;left:12px;bottom:12px;max-width:600px;padding:8px 10px;background:#fff3cd;border:1px solid #ffe08a;border-radius:8px;font:12px system-ui;color:#533f03;z-index:9999;white-space:pre-wrap;display:none}
</style>
</head>
<body>
  <div class="top">
    <strong>Listio</strong>
    <div class="spacer"></div>
    <div id="who" class="muted"></div>
    <button id="signout" class="btn" style="display:none">Sign out</button>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div style="font-weight:600;margin-bottom:8px">Your Board</div>
      <div style="color:var(--muted);font-size:12px">Columns appear on the right</div>
    </aside>
    <main class="board">
      <button id="btn-create-board" class="btn">Create Board</button>
      <button id="btn-add-column" class="btn">+ Add Column</button>
    </main>
  </div>

  <div id="dbg"></div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // --- Supabase config (yours) ---
  const SUPABASE_URL = "https://xqxuccpotbdmqqhxisdf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxeHVjY3BvdGJkbXFxaHhpc2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTg5MjYsImV4cCI6MjA3MDMzNDkyNn0.Jb3LaflzKGT6di_t14FLbGdexQ2lTKQ-dIt5Ve9aP-8";
  const STORAGE_KEY   = "listio-auth-v1";
  const AUTH_URL      = "/Listio/auth.html";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey: STORAGE_KEY }
  });

  // --- UI refs
  const dbg = document.getElementById('dbg');
  const who = document.getElementById('who');
  const signout = document.getElementById('signout');
  const boardEl = document.querySelector('.board');

  function show(msg){ dbg.textContent = msg; dbg.style.display = 'block'; }
  function clearDbg(){ dbg.style.display = 'none'; }

  // --- Gate
  async function gate(){
    const { data } = await supabase.auth.getSession();
    const session = data?.session || null;
    if (!session){
      show('No session â†’ redirecting to sign inâ€¦');
      signout.style.display = 'none';
      setTimeout(()=>location.replace(AUTH_URL), 200);
      return null;
    }
    who.textContent = session.user.email + ' â€¢ ' + session.user.id.slice(0,8);
    signout.style.display = 'inline-flex';
    return session;
  }
  signout.addEventListener('click', async ()=>{
    await supabase.auth.signOut(); localStorage.removeItem(STORAGE_KEY); location.replace(AUTH_URL);
  });
  supabase.auth.onAuthStateChange(async (ev)=>{ if (ev==='SIGNED_OUT') gate(); if (ev==='SIGNED_IN'||ev==='TOKEN_REFRESHED') gate(); });
  // document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible') gate().then(loadBoard); });
  // window.addEventListener('focus', ()=>gate().then(loadBoard));

  // --- Data
  let session = null;
  let currentBoardId = null;

  async function ensureBoard(){
    const s = await gate(); if (!s) return null; session = s;
    const uid = s.user.id;
    const { data: boards, error } = await supabase.from('boards').select('*').eq('owner_id', uid).limit(1);
    if (error){ show('Load boards error: ' + error.message); return null; }
    if (boards?.length){ currentBoardId = boards[0].id; return currentBoardId; }
    const { data: created, error: cErr } = await supabase
      .from('boards').insert({ title: 'My Board', owner_id: uid }).select('*').single();
    if (cErr){ show('Create board error: ' + cErr.message); return null; }
    currentBoardId = created.id; return currentBoardId;
  }

  async function loadBoard(){
    clearDbg();
    const id = currentBoardId || await ensureBoard();
    if (!id) return;

    // fetch columns
    const { data: columns, error } = await supabase
      .from('columns').select('id, title, position').eq('board_id', id).order('position', { ascending: true });
    if (error){ show('Load columns error: ' + error.message); return; }

    // render
    boardEl.innerHTML = '';
    (columns || []).forEach(c => boardEl.appendChild(renderColumn(c)));

    // add column button
    const add = document.createElement('button');
    add.className = 'btn';
    add.textContent = '+ Add Column';
    add.onclick = async ()=>{
      const { error } = await supabase.from('columns').insert({
        board_id: currentBoardId,
        title: 'New Column',
        owner_id: session.user.id,
        position: Math.floor(Date.now()/1000)
      });
      if (error) show('Insert column failed: ' + error.message);
    };
    boardEl.prepend(add);
  }

  function renderColumn(col){
    const wrap = document.createElement('div');
    wrap.className = 'column';
    wrap.style.marginLeft = '12px';
    wrap.innerHTML = `
      <div class="col-header">
        <div class="col-title" contenteditable="true">${col.title}</div>
        <div class="col-actions" style="margin-left:auto;display:flex;gap:4px">
          <button class="icon-btn" title="Delete">ðŸ—‘</button>
        </div>
      </div>
      <div class="cards"></div>
      <div class="adder">
        <input placeholder="Add a card..." />
        <button class="btn">Add</button>
      </div>
    `;

    // title edit
    const titleEl = wrap.querySelector('.col-title');
    titleEl.addEventListener('blur', async ()=>{
      const newTitle = titleEl.textContent.trim() || 'Untitled';
      const { error } = await supabase.from('columns').update({ title: newTitle }).eq('id', col.id);
      if (error) show('Rename column failed: ' + error.message);
    });

    // delete column
    wrap.querySelector('.icon-btn').onclick = async ()=>{
      const { error } = await supabase.from('columns').delete().eq('id', col.id);
      if (error) show('Delete column failed: ' + error.message);
    };

    // load cards
    (async ()=>{
      const { data: cards, error } = await supabase
        .from('cards').select('*').eq('column_id', col.id).order('position', { ascending: true });
      if (error){ show('Load cards error: ' + error.message); return; }
      const cardsEl = wrap.querySelector('.cards');
      (cards || []).forEach(card => cardsEl.appendChild(renderCard(card)));
    })();

    // add card
    const input = wrap.querySelector('.adder input');
    wrap.querySelector('.adder button').onclick = async ()=>{
      const text = input.value.trim(); if (!text) return;
      const { error } = await supabase.from('cards').insert({
        column_id: col.id, text, position: Math.floor(Date.now()/1000), created_by: session.user.id
      });
      if (error) show('Add card failed: ' + error.message);
      else input.value = '';
    };

    return wrap;
  }

  function renderCard(card){
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `
      <input class="checkbox" type="checkbox" ${card.checked ? 'checked' : ''}/>
      <div class="card-text" contenteditable="true">${card.text || ''}</div>
      <div class="meta"></div>
    `;
    el.querySelector('.checkbox').addEventListener('change', async (e)=>{
      const { error } = await supabase.from('cards').update({ checked: e.target.checked }).eq('id', card.id);
      if (error) show('Toggle card failed: ' + error.message);
    });
    el.querySelector('.card-text').addEventListener('blur', async (e)=>{
      const { error } = await supabase.from('cards').update({ text: e.target.textContent }).eq('id', card.id);
      if (error) show('Edit card failed: ' + error.message);
    });
    return el;
  }

  // Realtime
  function subscribeRealtime(){
    supabase.channel('columns-ch')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'columns' }, () => loadBoard())
      .subscribe();
    supabase.channel('cards-ch')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'cards' }, () => loadBoard())
      .subscribe();
  }

  // Start
  (async ()=>{
    const s = await gate(); if (!s) return;
    session = s;
    await ensureBoard();
    subscribeRealtime();
    await loadBoard();
  })();
</script>
