<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Listio</title>
<style>
  :root{--line:#eceff3;--accent:#2d6cdf;--muted:#9aa3ae;--ink:#1f2937}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f7f8fa;color:var(--ink)}
  .top{display:flex;gap:8px;align-items:center;padding:12px 18px;border-bottom:1px solid var(--line);background:#fff}
  .spacer{flex:1}
  .btn{all:unset;background:#eef2ff;border:1px solid #d6e6ff;padding:6px 10px;border-radius:6px;cursor:pointer}
  .app{display:grid;grid-template-columns:240px 1fr;height:calc(100% - 49px)}
  .sidebar{padding:18px;border-right:1px solid var(--line);background:#fff}
  .board{height:100%;overflow:auto;padding:16px}
  #dbg{position:fixed;left:12px;bottom:12px;max-width:600px;padding:8px 10px;background:#fff3cd;border:1px solid #ffe08a;border-radius:8px;font:12px system-ui;color:#533f03;z-index:9999;white-space:pre-wrap}
</style>
</head>
<body>
  <div class="top">
    <strong>Listio</strong>
    <div class="spacer"></div>
    <div id="who" class="muted"></div>
    <button id="signout" class="btn" style="display:none">Sign out</button>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div style="font-weight:600;margin-bottom:8px">Your Board</div>
      <div style="color:var(--muted);font-size:12px">Columns appear on the right</div>
    </aside>
    <main class="board">
      <!-- we’ll inject UI later; for now just gate -->
    </main>
  </div>

  <div id="dbg" style="display:none"></div>

  <!-- Supabase SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://xqxuccpotbdmqqhxisdf.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxeHVjY3BvdGJkbXFxaHhpc2RmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTg5MjYsImV4cCI6MjA3MDMzNDkyNn0.Jb3LaflzKGT6di_t14FLbGdexQ2lTKQ-dIt5Ve9aP-8";
    const STORAGE_KEY = "listio-auth-v1";
    const AUTH_URL = "/Listio/auth.html";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey: STORAGE_KEY }
    });

    const dbg = document.getElementById('dbg');
    const who = document.getElementById('who');
    const signout = document.getElementById('signout');

    function show(msg){ dbg.textContent = msg; dbg.style.display = 'block'; }

    async function gate(){
      const { data } = await supabase.auth.getSession();
      const session = data?.session || null;
      if (!session){
        show('No session → redirecting to sign in…');
        setTimeout(()=>location.replace(AUTH_URL), 300);
        return;
      }
      // show who’s signed in
      who.textContent = session.user.email + ' • ' + session.user.id.slice(0,8);
      signout.style.display = 'inline-flex';
      show('SESSION OK. You are signed in. (No database calls yet.)');
    }

    signout.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
      localStorage.removeItem(STORAGE_KEY);
      location.replace(AUTH_URL);
    });

    // Guard against tab-switch flicker
    supabase.auth.onAuthStateChange(async (ev, s)=>{
      if (ev === 'SIGNED_OUT'){ setTimeout(gate, 200); }
      if (ev === 'SIGNED_IN' || ev === 'TOKEN_REFRESHED'){ setTimeout(gate, 0); }
    });
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible') gate(); });
    window.addEventListener('focus', gate);

    gate();
  </script>
</body>
</html>
